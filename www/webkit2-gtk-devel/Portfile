# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

# We have an umbrella radar tracking webkit-gtk issues on OS X.  Please relate
# any future issues with this tracker.
# http://bugs.webkit.org/show_bug.cgi?id=126492

PortSystem          1.0
PortGroup           active_variants 1.1
PortGroup           cmake 1.1
PortGroup           legacysupport 1.1

# TARGET_OS_TV etc
legacysupport.newest_darwin_requires_legacy 13

compiler.cxx_standard 2020
cmake.generator     Ninja

name                webkit2-gtk-devel
conflicts           webkit2-gtk
version             2.35.3
revision            0

description         Apple's WebKit2 HTML rendering library for GTK+3
long_description    ${description}
maintainers         {devans @dbevans}
categories          www gnome
platforms           darwin freebsd
license             LGPL-2+ BSD
homepage            http://webkitgtk.org/
master_sites        http://webkitgtk.org/releases/

use_xz              yes
distname            webkitgtk-${version}

dist_subdir         webkit-gtk

checksums           rmd160  a8c20f9d45bfba6461080bbd2579898a8c9ccfa0 \
                    sha256  4c797dcfe1cb8460baf8058b37077764217226e8577f3b5bbc5f15cd673a499a \
                    size    26789900

depends_build-append \
                    port:gperf \
                    port:gtk-doc \
                    port:pkgconfig \
                    port:python27 \
                    port:py27-simplejson

depends_lib-append  port:atk \
                    port:at-spi2-atk \
                    port:bison \
                    path:lib/pkgconfig/cairo.pc:cairo \
                    port:flex \
                    port:fontconfig \
                    port:freetype \
                    port:lcms2 \
                    port:enchant2 \
                    port:geoclue2 \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    path:lib/pkgconfig/gobject-introspection-1.0.pc:gobject-introspection \
                    port:gstreamer1 \
                    port:gstreamer1-gst-plugins-bad \
                    port:gstreamer1-gst-plugins-base \
                    port:gstreamer1-gst-plugins-good \
                    path:lib/pkgconfig/gtk+-3.0.pc:gtk3 \
                    path:lib/pkgconfig/harfbuzz-icu.pc:harfbuzz-icu \
                    port:hyphen \
                    port:icu \
                    path:include/turbojpeg.h:libjpeg-turbo \
                    port:libgcrypt \
                    port:libnotify \
                    port:libpng \
                    port:libsecret \
                    port:libsoup \
                    port:libxml2 \
                    port:libxslt \
                    port:openjpeg \
                    port:sqlite3 \
                    port:webp \
                    port:woff2 \
                    port:zlib


# 1. add missing JavaScriptCore include directory used only on Apple webkit builds
# 2. add missing WebCore include directory used only on Apple webkit builds
# 3. add a missing Apple-only header found in the WebKit project
# 4. change some int64_t to gint64 to stop typedef errors in gstreamer
patchfiles-append   patch-webkit2gtk-macports.diff

# and a few more for webkit2-gtk-2.27.2
patchfiles-append   patch-webkit2gtk-272-macports.diff

# enable Netscape plugin architecture on macOS
# or can be explicitly disabled with the following addition if preferred
# configure.args-append -DENABLE_NETSCAPE_PLUGIN_API=OFF
patchfiles-append    patch-enable-plugin-architecture-unix.diff

# add a link library to WebCore. I am not sure this is still needed; builds and
# runs without this patch.
patchfiles-append    patch-bundle-link-webcore.diff

# allow the webkit executables typically located in libexec to be
# dynamically located, this is useful for app bundling
patchfiles-append    process-executable-path.diff

# add new sources for NSApplicationActivationPolicy.mm
patchfiles-append    patch-sources-gtk.diff

# patch web process to add call to SetActivationPolicyProhibited
patchfiles-append    patch-web-process-main.diff

# error: no matching constructor for initialization of 'std::filesystem::path'
patchfiles-append    patch-filesystem-path.diff

# it is preferred to use the WebKit built in bmalloc if it builds on a given os.
# it has improved security features, but not all systems can build it at present.

configure.args-append \
    -DPORT=GTK \
    -DENABLE_GAMEPAD=OFF \
    -DENABLE_INTROSPECTION=ON \
    -DENABLE_JOURNALD_LOG=OFF \
    -DENABLE_MINIBROWSER=OFF \
    -DENABLE_VIDEO=ON \
    -DUSE_APPLE_ICU=OFF \
    -DUSE_SOUP2=ON \
    -DUSE_SYSTEM_MALLOC=OFF \
    -DUSE_WPE_RENDERER=OFF

pre-configure {
    if {![variant_isset quartz] && ![variant_isset x11]} {
        error "Either +x11 or +quartz is required"
    }
}

post-patch {
    file copy ${filespath}/NSApplicationActivationPolicy.h ${worksrcpath}/Source/WebKit/WebProcess/gtk/NSApplicationActivationPolicy.h
    file copy ${filespath}/NSApplicationActivationPolicy.mm ${worksrcpath}/Source/WebKit/WebProcess/gtk/NSApplicationActivationPolicy.mm
}

if {![variant_isset quartz]} {
    default_variants-append +x11
}

# this is nice to have, and should be the default
default_variants-append +minibrowser

variant quartz conflicts x11 {
    require_active_variants path:lib/pkgconfig/gtk+-3.0.pc:gtk3 quartz

    configure.args-append \
        -DENABLE_QUARTZ_TARGET=ON \
        -DENABLE_X11_TARGET=OFF \
        -DUSE_OPENGL_OR_ES=OFF

# OPENGL does not work with +quartz, eg: https://trac.macports.org/ticket/52495
# OPENGL must be explicitly turned off, otherwise GLX is found, but X11 is not, and:
# CMake Error at Source/cmake/OptionsGTK.cmake:280 (message):
#  Either GLX or EGL is needed.

}

variant x11 conflicts quartz {
    require_active_variants path:lib/pkgconfig/gtk+-3.0.pc:gtk3 x11

    configure.args-append \
        -DENABLE_QUARTZ_TARGET=OFF \
        -DENABLE_X11_TARGET=ON \
        -DUSE_OPENGL_OR_ES=ON

    depends_lib-append \
        port:mesa \
        port:xorg-libXt
}

variant minibrowser description {Build and install MiniBrowser (for testing)} {
    configure.args-delete   -DENABLE_MINIBROWSER=OFF
    configure.args-append   -DENABLE_MINIBROWSER=ON
    depends_run-append       port:adwaita-icon-theme
}

# see https://trac.macports.org/ticket/56792
# no success at building universal after considerable attempts
# errors out in the javascript interpreter
# muniversal PG does not fix it. disabling the JIT does not fix it
# help wanted, if suitably motivated
universal_variant   no

# the above code presently builds as-in on 10.13 and up
if {${os.platform} eq "darwin" && ${os.major} <= 16} {

    # build of bmalloc fails up to 10.12 https://trac.macports.org/ticket/59447
    configure.args-replace -DUSE_SYSTEM_MALLOC=OFF -DUSE_SYSTEM_MALLOC=ON
    patchfiles-append       patch-ramsize.diff

    # error: use of undeclared identifier 'malloc_good_size'
    patchfiles-append       patch-fastmalloc.diff

    # error: no member named 'getMSBSetConstexpr' in namespace 'WTF'
    patchfiles-append       patch-gigacage.diff

    # Source/WTF/wtf/posix/CPUTimePOSIX.cpp : add back a previous Darwin compat version
     patchfiles-append      patch-source-wtf-wtf-unix-cputimeunix-cpp-darwin-version-restore.diff

    # some Darwin versions don't have MAP_JIT; only use it if available
    patchfiles-append       patch-source-wtf-wtf-osallocatorposix-cpp-map-jit.diff

    # gl cocoa build continues to fail due to use of API not available on darwin 12 or earlier
    # so gstreamergl is not available at present for darwin 12 or earlier
    # todo clarify further where this is exactly needed
    configure.args-append -DUSE_GSTREAMER_GL=OFF

    # for the webcore/page/crypt code to flow correctly,
    # ENABLE_WEB_CRYPTO has to be ON for 10.10+ and OFF for 10.9 and less
    if {${os.major} <= 13} {
        configure.args-append  -DENABLE_WEB_CRYPTO=OFF
    }
    # disable Apple internal security libraries, available only on new systems
    patchfiles-append       patch-Webcore-page-crypto.diff

    # restrict special process memory kernel calls to 10.9+ that support them
    patchfiles-append       patch-WTF-wtf-spi-darwin-ProcessMemoryFootprint-h.diff

    # the darwin build uses security features that are Apple internal only, but
    # the unix version does not FIXME: sort the ifdefs out
    # https://bugs.webkit.org/show_bug.cgi?id=157554
    patchfiles-append       patch-WTF-wtf-Randomdevice.diff

    # error: use of undeclared identifier 'mach_vm_offset_t'
    patchfiles-append       patch-WTF-wtf-Packed.diff

    # fatal error: 'wtf/spi/cocoa/MachVMSPI.h' file not found
    patchfiles-append       patch-WTF-wtf-WTFConfig.diff

    # fatal error: 'os/log.h' file not found
    patchfiles-append       patch-os-log.diff
    
    # disable veclib on 10.7 and 10.8. There is a definition for
    # class complex<> in the vForce.h header that collides with libc++
    # if anyone has a more elegant fix for this, please volunteer it
    if {${os.major} == 11 || ${os.major} == 12} {
        patchfiles-append       patch-webcore-platform-audio-directconvolver-disable-veclib.diff
    }

    # mach_approximate_time introduced in 10.9 (add to legacysupport?)
    if {${os.major} < 13} {
        configure.cxxflags-append -Dmach_approximate_time=mach_absolute_time
    }

    # documented in vm_statistics.h but not actually defined on Snow Leopard
    if {${os.major} < 11} {
        configure.cxxflags-append -DVM_FLAGS_OVERWRITE=0x4000
    }

    # add dep for newer ruby and spec this for build
    # https://trac.macports.org/ticket/52016
    depends_build-append    port:ruby27
    configure.args-append   -DRUBY_EXECUTABLE=${prefix}/bin/ruby2.7

    # fix missing PRId64 definitions on systems
    # that don't define __STDC_FORMAT_MACROS by default
    # https://bugs.webkit.org/show_bug.cgi?id=156596
    # https://trac.macports.org/ticket/52016
    patchfiles-append patch-snowleopard-cmakelists-stdcformatmacros.diff

    # special case: fix build on 10.6 with macports-libstdc++
    # contents of snowmath.h should someday become part of gcc6 cmath
    # TODO: remove this?
    if { ${configure.cxx_stdlib} eq "macports-libstdc++"  && ${os.major} < 11 } {
        configure.cxxflags-append -D_GLIBCXX_USE_C99_MATH_TR1=1
        configure.cxxflags-append -include ${filespath}/snowmath.h
    }
}

notes-append "
If you are porting new software to use webkit2gtk on Apple systems,\
you will likely need to define BUILDING_GTK__ to get the correct\
behaviour from WebKitAvailability.h.
"

livecheck.type      regex
livecheck.url       http://webkitgtk.org/releases/
livecheck.regex     "webkitgtk-(\\d+(?:\\.\\d+)+)"
